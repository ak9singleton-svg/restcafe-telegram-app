<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Мини-апп магазина</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: var(--tg-theme-bg-color, #fff);
    color: var(--tg-theme-text-color, #000);
    display: flex; flex-direction: column; height: 100vh;
  }
  header, nav {
    background: var(--tg-theme-button-color, #0088cc);
    color: var(--tg-theme-button-text-color, #fff);
    padding: 10px 20px;
    display: flex; align-items: center; justify-content: space-between;
  }
  header select {
    font-size: 14px;
    padding: 5px; border-radius: 4px; border: none; outline: none;
  }
  .banner {
    background: #ffcc00; padding: 10px; text-align: center; font-weight: bold;
  }
  .categories {
    display: flex; overflow-x: auto;
    border-bottom: 1px solid #ccc;
    background: var(--tg-theme-section-bg-color, #f9f9f9);
  }
  .categories button {
    padding: 10px 15px; border: none; background: none; cursor: pointer; font-weight: bold; flex-shrink: 0;
  }
  .categories button.active {
    border-bottom: 3px solid var(--tg-theme-button-color, #0088cc);
    color: var(--tg-theme-button-color, #0088cc);
  }
  .product-list {
    flex-grow: 1; overflow-y: auto; padding: 10px 15px; background: var(--tg-theme-bg-color, #fff);
  }
  .product-card {
    border: 1px solid #ccc; margin-bottom: 10px; border-radius: 5px; overflow: hidden; display: flex; gap: 10px;
  }
  .product-card img {
    width: 100px; object-fit: cover; border-right: 1px solid #ccc;
  }
  .product-details {
    padding: 10px; flex-grow: 1;
  }
  .product-title {
    font-weight: bold; margin-bottom: 5px;
  }
  .product-description {
    font-size: 14px; color: #555;
  }
  nav {
    justify-content: space-around; position: sticky; bottom: 0;
  }
  nav button {
    background: none; border: none; color: var(--tg-theme-button-text-color, #fff); font-weight: bold; cursor: pointer;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
</head>
<body>
<header>
  <div>Магазин</div>
  <select id="langSelect">
    <option value="ru">Русский</option>
    <option value="kz">Қазақша</option>
  </select>
</header>
<div class="banner" id="bannerText">Загрузка акций...</div>
<div class="categories" id="categoryRow"></div>
<div class="product-list" id="productList"></div>
<nav>
  <button>Каталог</button>
  <button>Заказы</button>
  <button>Акции</button>
  <button>Контакты</button>
</nav>

<script>
  // Инициализация Supabase (замените на свои данные!)
  const SUPABASE_URL = 'https://gtinslbrwdpqkxeibuqs.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aW5zbGJyd2RwcWt4ZWlidXFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMjM1MjMsImV4cCI6MjA3NjY5OTUyM30.3LbYP6AcsQ-qVZtdMgH6pJYX0rWLFGSUmT6errUwJOY';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const langSelect = document.getElementById("langSelect");
  const categoryRow = document.getElementById("categoryRow");
  const productList = document.getElementById("productList");
  const bannerText = document.getElementById("bannerText");

  let currentLang = 'ru';
  let currentCategoryId = null;

  langSelect.onchange = async () => {
    currentLang = langSelect.value;
    await loadBanner();
    await loadCategories();
  };

  async function loadBanner() {
    let { data, error } = await supabase.from('banners').select(`text_${currentLang}`).limit(1);
    if(error) {
      bannerText.textContent = 'Ошибка загрузки акций';
      return;
    }
    bannerText.textContent = data.length ? data[0][`text_${currentLang}`] : 'Пока нет акций';
  }

  async function loadCategories() {
    let { data, error } = await supabase.from('categories').select(`id, name_${currentLang}`);
    if(error) {
      categoryRow.innerHTML = 'Ошибка загрузки категорий';
      return;
    }
    categoryRow.innerHTML = '';
    if(data.length === 0) {
      categoryRow.textContent = 'Категории не найдены';
      productList.innerHTML = '';
      return;
    }
    data.forEach((cat, index) => {
      const btn = document.createElement('button');
      btn.textContent = cat[`name_${currentLang}`];
      btn.classList.toggle('active', index === 0);
      btn.onclick = () => {
        currentCategoryId = cat.id;
        renderProducts(cat.id);
        setActiveCategory(btn);
      };
      categoryRow.appendChild(btn);
      if(index===0){
        currentCategoryId = cat.id;
        renderProducts(cat.id);
      }
    });
  }

  function setActiveCategory(activeBtn) {
    [...categoryRow.children].forEach(btn => btn.classList.remove('active'));
    activeBtn.classList.add('active');
  }

  async function renderProducts(categoryId) {
    let { data, error } = await supabase.from('products').select(`id, name_${currentLang}, description_${currentLang}, image_url`).eq('category_id', categoryId);
    if(error) {
      productList.innerHTML = 'Ошибка загрузки товаров';
      return;
    }
    productList.innerHTML = '';
    if(data.length === 0) {
      productList.textContent = 'Товары не найдены';
      return;
    }
    data.forEach(p => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img src="${p.image_url}" alt="${p[`name_${currentLang}`]}">
        <div class="product-details">
          <div class="product-title">${p[`name_${currentLang}`]}</div>
          <div class="product-description">${p[`description_${currentLang}`]}</div>
        </div>
      `;
      productList.appendChild(card);
    });
  }

  // Запускаем загрузку данных при старте
  (async () => {
    await loadBanner();
    await loadCategories();
  })();
</script>
</body>
</html>
